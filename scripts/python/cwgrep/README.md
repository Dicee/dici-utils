# Manual: cwgrep

## Description

`cwgrep` is a simple Python wrapper around the Cloudwatch Logs APIs which allows easy access to logs in multiple accounts. It is mainly aimed at users who find Cloudwatch UIs impractical and inefficient compared to standard bash tools such as `grep`, `cut`, `sort`, `uniq` etc, in particular in the context of multiple AWS accounts.
 The tool is tailored to the Ultraviolet Paris team accounts but written in a way that it's configurable (for all use cases I have thought about...) by changing a single JSON file: `cwgrep-config.json`.

## Features and advantages over Cloudwatch UIs

- with minor infrastructure in our accounts for permissions, it can allow fetching data from any service, stage or region without switching between multiple windows. The tool will know how to connect to each account.
- the tool uses the same filtering API the UI presumably uses, meaning retrieval is fast and a filter can be passed directly to Cloudwatch to limit the amount of data to pull locally
- the tool pipes the data to the `less` command, so you can directly work on it, but it also stores it on the disk, so running multiple queries on the same filter pattern/time window will be dead fast. Coming back to the results of a previous query will not require re-running the query.
- can use normal bash tools such as `less`, `grep`, `cut`, `sort`, `uniq`, which are very powerful
- if the data is split between multiple pages, all pages are fetched upfront to avoid wasting time "scrolling" at human speed until the interesting part appears
- the tool installs its dependencies and updates by itself (for the most part) once in a while. All you need to do is pull this package and add this folder to your PATH.
- sharing the output of a query in a ticket is easy (no annoying unsupported characters)
- sharing reproducible search queries in a ticket is easy (the tool logs the AWS CLI command it ran for getting the results)

## Supported operations

### Overview

```none
╭───courtino@38f9d36418c4.ant.amazon.com ~
╰➤  cwgrep -h
usage: cwgrep.py [-h] subcommand

positional arguments:
  subcommand
              fetch           Runs a filter query on a given log group and returns the results after writing them to a local file. This is equivalent to searching a log group in the Cloudwatch UI.
              fetch-multiple  Runs a filter query on the default log group of multiple services and aggregates the results in a single local file.
              query           Allows running a filter query equivalent to the Cloudwatch Insights UI. Only returns 1000 results (Cloudwatch limitation) at most, but is useful for its friendly syntax for OR queries
              clean-logs      Cleans the logs generated by this tool over time that are older than the specified duration
              tutorial        Provides detailed help about a given sub-command of this tool, with indications as to when to use it over another one, as well as usage examples.

optional arguments:
  -h, --help  show this help message and exit                        
```

### Detailed help

#### query

```none
╭───courtino@38f9d36418c4.ant.amazon.com ~
╰➤  cwgrep tutorial query
Description: This command is equivalent to a Cloudwatch Insights query in the AWS console for several accounts.
Recommended use case: This is the recommended command for typical cross-account queries or any query requiring multiple log groups per account, or using OR filter patterns. Be mindful that due to Cloudwatch's limitations, this command will not return more than 10,000 log events, which makes it a bad command to use for queries yielding large amounts of log events
Features:
	- query multiple log groups from multiple accounts at once
	- add multiple positive and negative filters (AND relationship)
	- filters of the form filter1 OR filter2
Unsupported features:
	- query specific log streams in a given log group
	- using different filters for each selected account. The filters must be compatible with all included log groups.
	- returning more than 10,000 results per account. Not suitable for large queries.
	- cross-region or cross-stage queries
Examples:
	- find all failure metrics from 2 example accounts except for one operation: cwgrep query --region pdx --stage beta -lg mm:querylog pm:querylog -s '5h ago' -f Failure -f '!ExcludedOperation'
	- query default log groups from several example services and a specific mission id: cwgrep query --region pdx --stage beta -lg mm pm mr -s '1h ago' -f my-uu-id
	- query multiple log groups for several example services, for a specific duration: cwgrep query --region pdx --stage beta -lg mm:integ,apollo e2e pm:app -s '1h ago' -d 30m

For more details about the syntax and usage of each option, please run "cwgrep query -h".
```

#### fetch-multiple

```none
╭───courtino@38f9d36418c4.ant.amazon.com ~
╰➤  cwgrep tutorial fetch-multiple
Description: This command is equivalent to a log group search in the AWS console for several accounts. For more information about the syntax, please check https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html.
Recommended use case: Sufficient for most cross-account simple queries. For a single account, fetch is slightly preferable as you can start reading the logs as soon as the first page is ready instead of waiting for all pages. Suitable for retrieving large amounts of logs (as much as you have space on your disk...).
Features:
	- query multiple log groups from multiple accounts at once (but one query per log group instead of per account for the "query" command)
	- add multiple positive and negative filters (AND relationship)
	- returning any amount of log events (suitable for large queries)
Unsupported features:
	- selecting which exact log streams to query
	- using different filters for each selected account. The filters must be compatible with all included log groups.
	- filters of the form filter1 OR filter2
	- cross-region or cross-stage queries
Examples:
	- retrieve logs from two example services for a given mission and request id: cwgrep fetch-multiple --region pdx --stage beta -lg mm pm -s '5h ago' -fp '"my-mission-uuid" "my-request-uuid"'
	- fetch cross-service logs for a given class, excluding an operation: cwgrep fetch-multiple --region pdx --stage beta -lg mm pm -s '5h ago' -fp 'CoralActivityTemplate -ExcludedOperation'

For more details about the syntax and usage of each option, please run "cwgrep fetch-multiple -h".
```

#### fetch

```none
╭───courtino@38f9d36418c4.ant.amazon.com ~
╰➤  cwgrep tutorial fetch
Description: This command is equivalent to a log group search in the AWS console for a single account . For more information about the syntax, please check https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/FilterAndPatternSyntax.html.
Recommended use case: Sufficient for most simple queries, it allows having quick feedback instead of waiting for the entire response, contrarily to other commands. Like fetch-multiple, it is well-suited for retrieving large amounts of logs. Finally, this is also the only command allowing to query the latest log stream, or a specific log stream (e.g. logs from a single host).
Features:
	- query all log streams from a single log group of a single account
	- query a subset of log streams from a single log group of a single account
	- query the latest log stream from a single log group of a single account
	- add multiple positive and negative filters (AND relationship)
	- returning any amount of log events (suitable for large queries)
Unsupported features:
	- cross-account queries
	- filters of the form filter1 OR filter2
Examples:
	- filter by multiple criteria: cwgrep fetch --region pdx --stage beta --service mm -s '2020-01-06T13:00:00Z' -d 2h -fp '"filter 1"' '"filter2"'
	- count number of occurrences for each exception type and sort by frequency: cwgrep fetch --region pdx --stage beta --service mm -s '5h ago' -fp Exception | sort | uniq -c | sort -t1 -nr
	- fetch logs from a non-default log group: cwgrep fetch --region pdx --stage beta --service mm -s '5h ago' -klg integ
	- fetch logs from the latest log stream: cwgrep fetch --region pdx --stage beta --service mm -s '5h ago' --latest-stream
	- fetch the last log stream for end-to-end tests: cwgrep fetch --region pdx --stage beta --service e2e -s '5h ago' --latest-stream
	- fetch application logs from a specific host: cwgrep fetch --region pdx --stage beta --service pm -s '5h ago' --log-streams ip-10-0-62-130
	- fetch logs from a for a given class, excluding an operation: cwgrep fetch-multiple --region pdx --stage beta --service mm pm -s '5h ago' -fp 'CoralActivityTemplate -ExcludedOperation'

For more details about the syntax and usage of each option, please run "cwgrep fetch -h".
```

## Installation

The tool will install its dependencies automatically except some basic dependencies that are expected to already
be available (e.g. bash, brew, python3, pip3 etc). The tool auto-updates every 2 days before executing the command
requested by the user. It should also update your path automatically, so all you should have to do is the following:

```bash
# can also do it inside a Brazil workspace
git clone https://github.com/Dicee/dici-utils.git
cd dici-utils/scripts/python/cwgrep
./cwgrep -h # triggers the installation
cd
cwgrep -h # verify we can now access the tool from anywhere 
```

## Backlog

### Features
- add support for custom log group
- see if there's a reliable way to automatically discover the name of dynamically named log groups
- if possible, can add colors to some patterns in the logs, for example the pattern specified in `-fp`, or things like INFO etc
- `fetch-multiple` should behave like `fetch` when there's a single log group, and then there will be no need to have two commands

### Bugs (those that are not features!)

### Code improvements
- clean up how logging is done, it's getting messy 
- extract code shared with the Brazil workspace tool elsewhere
- consider writing events as JSON lines instead of a single JSON array in order to stream through them cheaply during the raw logs merge (i.e. without storing all of them in memory)

## Dependencies

- toolbox
- bash (for Windows users, assuming the Ubuntu bash would work)
- ada
- brew (Mac OSX only)
- yum (RHEL54 only)
- apt-get (Ubuntu only)
- git
- python3
- pip3 (normally comes with python3)
- arghandler (Python module)
- sty (Python module)
- pytimeparse (Python module)
- boto3
- requests
- urllib3
